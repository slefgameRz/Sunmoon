# ⚡ Quick Start: From Current State to Phase 1 Complete

**Goal**: Transform SEAPALO from demo into Phase 1 foundation (Weeks 1–3)  
**Target Completion**: 3 weeks  
**Key Outputs**: WASM core stub, tile schema, PWA precursor  

---

## 📋 Pre-Phase 1 Tasks (This Week)

### Task 1.1: Decision Gate — WASM Language
**Owner**: Tech Lead  
**Time**: 2 hours decision + 1 day spike

**Options**:
| Language | Pros | Cons | Learning Curve |
|----------|------|------|-----------------|
| **Rust** | Memory safe, fast, excellent WASM tooling (wasm-pack) | New skill for team | 2–3 weeks |
| **C/C++** | Fast, battle-tested (TPXO/FES use it) | Manual memory, more boilerplate | 1–2 weeks |
| **JS** | Already in codebase, rapid dev | Slower compute, no offline worker threads | <1 week |

**Decision Output**:
- [ ] Language chosen
- [ ] Proof-of-concept working (trivial function, e.g., `add(a, b)` in WASM, called from JS)
- [ ] Build pipeline established (cargo/wasm-pack OR emscripten OR tsc)
- [ ] Document in `docs/WASM_SETUP.md`

**Recommended**: **Rust** (safer, faster, standard in oceanography tools)

---

### Task 1.2: Data Sources Audit
**Owner**: Data/PM  
**Time**: 1 week

**Checklist**:
- [ ] **Global Model Choice**: Contact ESA (FES2022) OR Oregon State (TPXO9.2)
  - Goal: Get download link + license confirmation (commercial OK? redistribution OK?)
- [ ] **Thai Station Data**: 
  - [ ] Contact Royal Thai Navy Hydrographic Department (ศูนย์สำรวจน้ำท้องทะเล)
  - [ ] Check if 60-day reference data available (Bangkok, Chachoengsao, Phuket)
  - [ ] Verify licensing (can integrate into app?)
- [ ] **Document License Matrix**:
  - Create `docs/LICENSE_MATRIX.md`
  - Table: Data Source | License | Distribution OK? | Modification OK? | Attribution Required?
- [ ] **ATTRIBUTION.md**: Draft credits for homepage footer

**Output**: `docs/LICENSE_MATRIX.md` + sample data download link

---

### Task 1.3: Baseline Accuracy Measurement
**Owner**: Data Science  
**Time**: 3–5 days

**Objective**: Establish ground truth for field test validation later

**Steps**:
1. Download reference tide data for 3 Thai sites (60 days each, if available):
   - Bangkok (Chao Phraya mouth, lat 13.72°, lon 100.57°)
   - Chachoengsao (Bang Pakong estuary, lat 13.46°, lon 101.08°)
   - Phuket (Ao Yon, lat 7.88°, lon 98.40°)
2. Use current harmonic approximation in `lib/tide-service.ts` to predict
3. Calculate RMSE for high/low times + heights:
   - Separate spring vs neap
   - Record stats: `baseline_rmse_time_min.json`, `baseline_rmse_height_m.json`
4. Set target RMSE (goal: improve by 50% post-calibration)

**Output**: 
```json
{
  "baseline": {
    "bangkok": { "time_rmse_min": 24, "height_rmse_m": 0.35 },
    "chachoengsao": { "time_rmse_min": 28, "height_rmse_m": 0.42 },
    "phuket": { "time_rmse_min": 18, "height_rmse_m": 0.25 }
  },
  "target_post_calibration": {
    "bangkok": { "time_rmse_min": 12, "height_rmse_m": 0.18 },
    "chachoengsao": { "time_rmse_min": 14, "height_rmse_m": 0.20 },
    "phuket": { "time_rmse_min": 9, "height_rmse_m": 0.15 }
  }
}
```

---

## 🚀 Phase 1 Sprint (3 Weeks)

### Week 1: WASM Core Setup

#### Story 1.1.1: Define 37+ Constituent Set
**Tasks**:
- [ ] Create `docs/CONSTITUENTS.md`
  - List all 37 (M2, S2, N2, K2, K1, O1, P1, Q1, Mf, Mm, Sa, Ssa, + shallow)
  - Include frequency (rad/hour), period (hours), astronomical meaning
  - Mark which ones are "critical for Thai waters" vs "optional"
- [ ] Add to codebase: `lib/constituents.ts` (TS enum + lookup table)

**Acceptance**: `lib/constituents.ts` exports 37 constituents with all metadata

---

#### Story 1.1.2: WASM Skeleton (Rust Proof-of-Concept)
**Tasks**:
- [ ] Create `lib/wasm/` directory structure:
  ```
  lib/wasm/
  ├── Cargo.toml
  ├── src/
  │   ├── lib.rs (main module)
  │   ├── harmonic.rs (core algorithm)
  │   └── astronomy.rs (stubs: nodal factors, args)
  ├── pkg/ (generated by wasm-pack)
  └── README.md (build instructions)
  ```
- [ ] Implement **stub functions**:
  ```rust
  #[wasm_bindgen]
  pub fn astronomical_args_m2(year: i32, month: i32, day: i32) -> f32 {
    // Placeholder: return hardcoded value
    0.0
  }
  
  #[wasm_bindgen]
  pub fn harmonic_sum(
    constituents: &str,  // JSON
    time_hours: f32,
    args: &str  // JSON
  ) -> f32 {
    // Placeholder: sum first 3 constituents with mock data
    0.0
  }
  ```
- [ ] Set up CI (GitHub Actions):
  - `wasm-pack build lib/wasm --target web`
  - Output: `lib/wasm/pkg/seapalo_tide.js` + `.wasm`
- [ ] Test in JS:
  ```javascript
  import init, { harmonic_sum } from '@/lib/wasm/pkg/seapalo_tide'
  await init()
  const result = harmonic_sum('{}', 0, '{}')
  console.log('WASM works:', result)
  ```

**Acceptance**: WASM binary <800 KB; simple function callable from JS

---

#### Story 1.1.3: Fallback JS Implementation
**Tasks**:
- [ ] Create `lib/tide-compute-js.ts`:
  - Implement harmonic sum in pure JS (as backup)
  - Reuse existing `generateHarmonicTidePrediction()` logic
  - Make API signature identical to WASM version
- [ ] Error boundary: if WASM fails to load, auto-switch to JS
  ```typescript
  export async function getTideEngine() {
    try {
      await initWasm()
      return { type: 'wasm', predict: predictWasm }
    } catch (e) {
      console.warn('WASM unavailable, using JS:', e)
      return { type: 'js', predict: predictJS }
    }
  }
  ```

**Acceptance**: App works with JS fallback; warns user of potential slowdown

---

### Week 2: Tile Schema & PWA Basics

#### Story 2.1: Tile Schema & Packing Script
**Tasks**:
- [ ] Finalize `TileMeta` + `ConstituentData` + `MinorRule` schemas
  - Export TypeScript interfaces in `lib/tile-types.ts`
- [ ] Create `scripts/generate-tile.ts`:
  ```typescript
  // Usage: pnpm run generate-tile --model=FES2022 --bbox=13.5,14,100,101 --output=bangkok_001.br
  // Input: FES2022 global data (downloaded earlier)
  // Output: bangkok_001.br (brotli-compressed tile)
  ```
  - Extract constituents for bbox from FES data
  - Pack into binary format
  - Compress with brotli
  - Output SHA256 checksum
  - **Demo**: Generate 1 tile for Bangkok (target ≤300 KB)
- [ ] Document in `docs/TILE_FORMAT.md`

**Acceptance**: Generate Bangkok tile; verify <300 KB and loads without error

---

#### Story 2.2: IndexedDB Schema & Tile Manager
**Tasks**:
- [ ] Create `lib/tile-manager.ts`:
  ```typescript
  class TileManager {
    async loadTile(tilePayload: ArrayBuffer, tileId: string): Promise<void>
    async getTile(tileId: string): Promise<TileData | null>
    async listTiles(): Promise<string[]>
    async deleteTile(tileId: string): Promise<void>
    async clearOldTiles(maxAge: number): Promise<number> // LRU
    async verifyChecksum(tileId: string): Promise<boolean>
  }
  ```
- [ ] Implement IndexedDB schema:
  - Table: `tiles` (tileId, version, meta_json, constituents_blob, checksum, downloaded_at)
  - Table: `ephemerides` (date_key, v_array, u_array, f_array, expires_at)
  - Table: `sync_queue` (tile_id, action, status, error_msg)
- [ ] Implement LRU eviction:
  - When IndexedDB quota exceeded, delete oldest 3 tiles
  - Log: "Evicted tile X to free space"

**Acceptance**: Can store/retrieve tile from IndexedDB; LRU eviction works

---

#### Story 2.3: Service Worker & Manifest
**Tasks**:
- [ ] Create `public/sw.ts` (TypeScript Service Worker):
  - Precache: core JS, CSS, WASM binary, manifest icon
  - Cache strategy: tiles use cache-first; app uses network-first
  - Sync registration: background check every 30 days
- [ ] Generate `public/manifest.json` (PWA manifest):
  ```json
  {
    "name": "SEAPALO - Tide Prediction",
    "short_name": "SEAPALO",
    "start_url": "/",
    "scope": "/",
    "display": "standalone",
    "icons": [
      { "src": "/icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "/icon-512.png", "sizes": "512x512", "type": "image/png" }
    ],
    "theme_color": "#0ea5e9",
    "background_color": "#ffffff"
  }
  ```
- [ ] Register SW in `app/layout.tsx`:
  ```typescript
  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(e => console.warn('SW reg failed:', e))
    }
  }, [])
  ```
- [ ] Test offline: disable network in DevTools → app still works

**Acceptance**: App installable (Android: "Install app"); offline functional

---

### Week 3: Computation API & Performance

#### Story 3.1: Unified Prediction API
**Tasks**:
- [ ] Create `lib/predictor.ts`:
  ```typescript
  interface PredictionOptions {
    lat: number
    lon: number
    tStart: Date
    tEnd: Date
    stepMinutes: number
    datumOffset?: number
    includeConfidence?: boolean
  }
  
  export async function predictTide(opts: PredictionOptions): Promise<{
    series: TidePrediction[]
    highLowEvents: TideEvent[]
    metadata: { computeTimeMs: number; engine: 'wasm' | 'js' }
  }>
  ```
- [ ] Load tile (if available), fall back to equilibrium if not
- [ ] Compute using WASM or JS
- [ ] Find high/low events via zero-crossing detection
- [ ] Return series + events + metadata

**Acceptance**: Predict 72 hours on mock data in <500 ms (JS), <150 ms (WASM goal)

---

#### Story 3.2: Performance Profiling
**Tasks**:
- [ ] Add performance markers:
  ```typescript
  performance.mark('predict-start')
  const result = await predictTide(opts)
  performance.mark('predict-end')
  performance.measure('predict', 'predict-start', 'predict-end')
  ```
- [ ] Test on real devices:
  - [ ] Desktop (Chrome/Firefox)
  - [ ] Mid-range Android (2–3 GHz, 4 GB RAM)
  - [ ] iPad (recent)
- [ ] Record baseline times; identify bottlenecks

**Acceptance**: Document in `PERFORMANCE_LOG.md` with baseline times

---

#### Story 3.3: Acceptance Tests
**Tasks**:
- [ ] Unit tests (Jest):
  ```typescript
  describe('Prediction API', () => {
    it('should predict tide without NaN', async () => {
      const result = await predictTide(mockOptions)
      expect(result.series.every(p => Number.isFinite(p.level))).toBe(true)
    })
    
    it('should find high/low within 10-min accuracy', async () => {
      // Use reference golden data
    })
  })
  ```
- [ ] E2E test: Load Bangkok tile → predict → display graph → verify output

**Acceptance**: Unit + E2E tests passing; coverage ≥80%

---

## 📊 Phase 1 Exit Criteria (All Must Pass)

| Criterion | Status | Notes |
|-----------|--------|-------|
| WASM binary <800 KB | ❌ TBD | Rust stub compiled |
| JS fallback works | ❌ TBD | API parity |
| Bangkok tile generated & <300 KB | ❌ TBD | Real FES data |
| IndexedDB tile storage + retrieval | ❌ TBD | LRU eviction tested |
| Service Worker precache works | ❌ TBD | App installable |
| 72-hour prediction computed | ❌ TBD | Harmon sum correct |
| High/low finder accurate ±10 min | ❌ TBD | Against baseline |
| Offline scenario passes | ❌ TBD | No network → still predicts |
| Unit tests ≥80% coverage | ❌ TBD | Critical paths |
| Documentation (setup, API, tile format) | ❌ TBD | README + 3 docs |

---

## 📌 Known Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|-----------|
| WASM complexity overruns | High | Use Rust template from wasm.rs; allocate +5 days buffer |
| FES/TPXO data access blocked | High | Contact ESA/Oregon NOW; have fallback synthetic data ready |
| IndexedDB quota issues | Medium | Test on devices with 50 MB quota; implement aggressive LRU |
| WASM performance inadequate on old phones | Medium | JS fallback; profile early; optimize hot paths (harmonic sum) |
| Thai station data unavailable | Medium | Use historical NOAA/UK Hydrographic data as proxy; note in docs |

---

## 🎯 Success Metrics (Post-Phase 1)

1. **Technical Readiness**
   - WASM stub compiles; simple function works
   - Tile generation pipeline functional
   - PWA installable + offline capable

2. **Accuracy Baseline**
   - Current JS prediction: baseline RMSE established (avg ≈22 min for time, ≈0.34 m for height)
   - Target post-Phase 5: RMSE ≤12 min, ≤0.18 m

3. **Team Confidence**
   - All foundational decisions made (language, data source)
   - No blockers identified
   - Ready to enter Phase 2 (data integration)

---

## 📞 Escalation & Communication

**Weekly Sync**: Every Monday 10 AM (GMT+7)
- [ ] Progress update
- [ ] Blockers & risks
- [ ] Next week preview

**Slack Channels**:
- `#seapalo-dev` : Technical discussions
- `#seapalo-releases` : Deployment notifications

**Decision Log**: `docs/DECISIONS.md`
- Record all major choices (e.g., "Chose Rust on 2025-10-21 because...")

---

## 📚 Reference & Resources

**Setup Guides**:
- [ ] `docs/WASM_SETUP.md` (Rust + wasm-pack quick start)
- [ ] `docs/TILE_GENERATION.md` (FES download + tile packing)
- [ ] `docs/PWA_SETUP.md` (Service Worker + manifest)

**External Resources**:
- Rust + WASM: https://rustwasm.org/
- FES2022: https://www.aviso.altimetry.fr/en/data/products/fes-model.html
- IHO Tidal Harmonic: https://www.iho.int/

---

**Phase 1 Owner**: @tech-lead  
**Phase 1 Deadline**: 3 weeks from kickoff  
**Status**: Awaiting approval to begin  
**Last Updated**: 2025-10-20
